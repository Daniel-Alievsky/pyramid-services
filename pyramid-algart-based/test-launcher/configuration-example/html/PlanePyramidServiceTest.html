<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PlanePyramidTest</title>
</head>
<body bgcolor="#e3efcc">
<div id="information"></div>
<script>
    var zeroLevelObjective = 20; // in future version will be loaded from the pyramid
    var search = document.location.search.substr(1);
    var parameters = search.split(":");
    var pyramidId = parameters[0];
    var tmsPyramidId = pyramidId;
    var zoomifyPyramidId = pyramidId;
    var port = parameters[1];
    var compression = parameters.length >= 3 ? parseInt(parameters[2]) : 2;
    var unsafe = parameters.length >= 4 ? parameters[3] == "unsafe" : false;
    var urlStart = 'http://localhost:' + port + (unsafe ? '/unsafe-' : '/pp-');
    if (unsafe) {
        pyramidId = encodeURI('{"pyramidPath": "') + pyramidId + encodeURI('"}');
        tmsPyramidId = '~~7B~~22pyramidPath~~22~~3A~~22'
                + tmsPyramidId.replace(/%3A/g, '~~3A').replace(/\//g, '~~2F') + '~~22~~7D';
    }
    document.writeln("Opening '" + pyramidId + "',<br/>tms '" + tmsPyramidId + "'<br/>");
</script>


<blockquote style="margin:30px 50px">
    <div id="control" style="margin:10px;visibility:hidden">
        <button onclick="changeObjective(2.5)">2.5x</button>
        <button onclick="changeObjective(5)">5x</button>
        <button onclick="changeObjective(10)">10x</button>
        <button onclick="changeObjective(20)">20x</button>
        &nbsp&nbsp;<span id="currentZoom"></span>
    </div>
    <div id="map" style="width:80%;height:500px;border:3px solid red"></div>
</blockquote>


<script src="http://openlayers.org/api/OpenLayers.js"></script>
<script>
    var tileDim = 256;

//    function getMyTmsUrl(bounds) {
//        var res = this.map.getResolution();
//        var x = Math.round((bounds.left - this.tileOrigin.lon) / (res * this.tileSize.w));
//        var y = Math.round((this.tileOrigin.lat - bounds.top) / (res * this.tileSize.h));
//        var z = this.map.getZoom();
//
//        return urlStart + "tms/" + tmsPyramidId + "/" + z + "/" + x + "/" + y + ".jpg";
//    }

    function initZoomify(zeroLevelDimX, zeroLevelDimY, port, zoomifyPyramidId){
//        alert("init: " + zeroLevelDimX + "x" + zeroLevelDimY);
        var imSize = new OpenLayers.Size(zeroLevelDimX, zeroLevelDimY);

        // The following line allows to emulate TMS intead of Zoomify, but not correct for boundary tiles:
        // OpenLayers.Layer.Zoomify.prototype.getURL = getMyTmsUrl;

        var zoomify = new OpenLayers.Layer.Zoomify("Zoomify",
                "http://localhost:" + port + "/pp-zoomify/" + zoomifyPyramidId + "/", imSize );
        /* Map with raster coordinates (pixels) from Zoomify image */
        var options = {
            maxExtent: new OpenLayers.Bounds(0, 0, zeroLevelDimX, zeroLevelDimY),
            maxResolution: Math.pow(2, zoomify.numberOfTiers-1),
            numZoomLevels: zoomify.numberOfTiers,
            units: 'pixels'
        };

        window.openLayersMap = new OpenLayers.Map("map", options);

        openLayersMap.addLayer(zoomify);
        openLayersMap.setBaseLayer(zoomify);
        openLayersMap.addControl(new OpenLayers.Control.LayerSwitcher());
        openLayersMap.addControl(new OpenLayers.Control.OverviewMap({
            minRatio: 0,
            maxRatio: openLayersMap.maxResolution,
            mapOptions: options
        }));
        openLayersMap.zoomToMaxExtent();
        document.getElementById("control").style.visibility = "visible";
    }

    function changeImage(pyramidId) {
        document.getElementById("control").style.visibility = "hidden";
        window.openLayersMap = null;
        document.getElementById("map").innerHTML = "";
        setTimeout("initZoomify(10000, 6250, 9001, '" + pyramidId + "')", 100);
        // setTimeout is necessary to allow browser to really visually hide "control" element
    }

    function changeObjective(newObjective) {
        if (window.openLayersMap == null) {
            // openLayersMap is not ready yet
            return;
        }
        var objective = zeroLevelObjective;
        var level = window.openLayersMap.getNumZoomLevels() - 1;
        while (objective > newObjective && level > 0) {
            objective /= 2;
            level--;
        }
        window.openLayersMap.zoomTo(level);
    }

    function showCurrentZoom() {
        if (window.openLayersMap != null) {
            document.getElementById("currentZoom").innerHTML =
                    "Level " + (window.openLayersMap.getZoom() + 1)
                    + " / " + window.openLayersMap.getNumZoomLevels()
                    + ", resolution " + window.openLayersMap.getResolution()
//                    + ", zoom " + window.openLayersMap.getZoomForResolution(window.openLayersMap.getResolution())
        }
    }
    setInterval(showCurrentZoom, 1000);

</script>
<hr>

<script>
    var xhr = new XMLHttpRequest();
    xhr.open('GET', urlStart + 'information?pyramidId=' + pyramidId, true);
    xhr.send();
    xhr.onreadystatechange = function () {
        if (xhr.readyState != 4) {
            return;
        }
        var result = "";
        if (xhr.status != 200) {
            result = "Error: cannot read pyramid information!</br>";
        } else {
            var info = JSON.parse(xhr.responseText);
            result = "Detected pyramid information:<br/>";
            result += "channelCount = " + info.channelCount + "<br/>";
            result += "zeroLevelDimX = " + info.zeroLevelDimX + "<br/>";
            result += "zeroLevelDimY = " + info.zeroLevelDimY + "<br/>";
            result += "elementType = " + info.elementType + "<br/>";
            initZoomify(info.zeroLevelDimX, info.zeroLevelDimY, port, zoomifyPyramidId);
        }
        document.getElementById("information").innerHTML = result;
    }
//    document.writeln("<plaintext>");
//    document.writeln(urlStart);

//    var args = 'pyramidId=' + pyramidId + encodeURI('&compression=5&fromX=0&fromY=0&toX=1000&toY=1000');
//    document.writeln('<br/><img src="' + urlStart + 'read-rectangle?' + args + '"><br/>');

    window.readRectangleHTML = "<br/>Random rectangles:<br/>";
    var tileDimX = 128 * compression;
    var tileDimY = 128 * compression;
    var sizeX = 1024 * compression;
    var sizeY = 512 * compression;
    for (var y = 0; y < sizeY; y += tileDimX) {
        readRectangleHTML += "Line y=" + y + "<br/>";
        for (var x = 0; x < sizeX; x += tileDimX) {
            args = 'pyramidId=' + pyramidId
                    + encodeURI('&compression=' + compression
                            + '&fromX=' + x
                            + '&fromY=' + y
                            + '&toX=' + (x + tileDimX)
                            + '&toY=' + (y + tileDimY));
            readRectangleHTML += '<img border="1" src="' + urlStart + 'read-rectangle?' + args + '">&nbsp;';
        }
        readRectangleHTML += "<br/>";
    }

    window.tmsHTML = "<br/>TMS:<br/>";
    var tmsXCount = 5;
    var tmsYCount = 5;
    var tmsZ = 3;
    for (var y = 0; y < tmsYCount; y++) {
        tmsHTML += "Line y=" + y + "<br/>";
        for (var x = 0; x < tmsXCount; x++) {
            args = tmsPyramidId + "/" + tmsZ + "/" + x + "/" + y;
            tmsHTML +=  '<img border="1" src="' + urlStart + 'tms/' + args + '">&nbsp;';
        }
        tmsHTML += "<br/>";
    }
</script>
<div id="changePyramid" style="margin:20px">
    <button onclick="changeImage('some-unique-folder-18572')">
        Switch to some-unique-folder-18572
    </button>
</div>
<div id="readRectangleTest" style="margin:20px">
    <button onclick="document.getElementById('readRectangleTest').innerHTML = readRectangleHTML">
        Show test with random access to rectangles
    </button>
</div>
<div id="tmsTest" style="margin:20px">
    <button onclick="document.getElementById('tmsTest').innerHTML = tmsHTML">
        Show test with access to rectangles via TMS protocol
    </button>
</div>

<!--
<script>
    document.writeln('<iframe width="100%" height="100" '
            + 'src="' + urlStart + 'information?pyramidId=' + pyramidId + '"><br/>');
</script>
-->

</body>
</html>