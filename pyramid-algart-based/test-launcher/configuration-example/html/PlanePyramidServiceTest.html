<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PlanePyramidTest</title>
</head>
<body bgcolor="#E8E8E8">
<!-- Non-white background color is for testing goals (to see the real boundaries of OpenLayers pyramid).
Professional version should use while color #FFFFFF -->
<script>

    // Loading pyramid ID and service port from arguments of URL.
    // In professional version they should be loaded by server-side script (ASP, PHP, JSP)
    // from configuration directory, for example, from /pp-links folder.

    var search = document.location.search.substr(1);
    var parameters = search.split(":");
    var currentPyramidId = parameters[0];
    var currentPort = parameters[1];
    var urlStart = 'http://localhost:' + currentPort + '/pp-';
    var tileDim = 256; // - 256 is the standard constant for OpenLayers protocols

    // Printing message about loading pyramid.
    // In professional version it can be some form of progress indicator.
</script>

<div id="macro" style="float:right"></div>
<div id="information">
    <script>
        document.writeln("Opening " + currentPyramidId + "...<br/>");
        // - will be replaced by real pyramid information in xhr.onreadystatechange() function
    </script>
</div>

<!-- Simple example of control and information panel --->
<blockquote style="margin:30px 50px;clear:both">
    <div id="control" style="margin:10px;visibility:hidden">
        <button onclick="changeObjective(2.5)">2.5x</button>
        <button onclick="changeObjective(5)">5x</button>
        <button onclick="changeObjective(10)">10x</button>
        <button onclick="changeObjective(20)">20x</button>
        &nbsp;&nbsp;<span id="currentZoom"></span>
    </div>
    <div id="map" style="width:80%;height:500px;border:3px solid red"></div>
</blockquote>

<div id="changePyramid" style="margin:20px">
    <!-- An example of code for changing pyramid in the current page;
    some-unique-folder-18572 subfolder with correct config.json should exist in /pp-links folder.
    In professional version, changePyramid function should be called when the user
    selects another pyramid from the list. -->
    An example of switching to another image:
    <button onclick="changePyramid('some-unique-folder-18572',9001)">
        Switch to some-unique-folder-18572
    </button>
</div>


<script src="http://openlayers.org/api/OpenLayers.js"></script>
<script>
    // The requestPyramid function sents a request to the server to load the pyramid and get its parameters;
    // when the server answers, it initializes pyramid by initOpenLayers function
    function requestPyramid(newPyramidId, newPort) {
        var xhr = new XMLHttpRequest();
        currentPort = newPort;
        currentPyramidId = newPyramidId;
        urlStart = 'http://localhost:' + newPort + '/pp-';
        xhr.open('GET', urlStart + 'information?pyramidId=' + newPyramidId, true);
        xhr.send();
        xhr.onreadystatechange = function () {
            if (xhr.readyState != 4) {
                return;
            }
            var result = "";
            if (xhr.status != 200) {
                result = "Error: cannot read pyramid information!</br>";
            } else {
                var info = JSON.parse(xhr.responseText);
                result = "<p>Detected pyramid information:</p>";
                result += "<pre>" + JSON.stringify(info, null, "  ") + "</pre>";
                zeroLevelObjective = info.magnification == null ? 20 : info.magnification;
                // - current versions of server, based on LOCI and other free libraries,
                // does not support info.magnification, so we will use default value 20
                initOpenLayers(info, newPort, newPyramidId);
            }
            document.getElementById("information").innerHTML = result;
        }
    }
    // Actual requesting the pyramid with ID from the 1st parameter in the URL (see the script in the very beginning).
    // This test calls this at the moment of loading page; professional version should call
    // this function when the user selects some image from the list.
    requestPyramid(currentPyramidId, currentPort);

    // The initOpenLayers function is called when the server replies to XMLHttpRequest
    // and returns the parameters of loaded pyramid:
    function initOpenLayers(info, port, pyramidId) {

        // The following line allows to emulate TMS intead of Zoomify, but not correct for boundary tiles:
//        OpenLayers.Layer.Zoomify.prototype.getURL = getMyTmsUrl;

        var imSize = new OpenLayers.Size(info.zeroLevelDimX, info.zeroLevelDimY);
        var zoomify = new OpenLayers.Layer.Zoomify("Zoomify",
                "http://localhost:" + port + "/pp-zoomify/" + pyramidId + "/", imSize);
        /* Map with raster coordinates (pixels) from Zoomify image */
        var options = {
            maxExtent: new OpenLayers.Bounds(0, 0, info.zeroLevelDimX, info.zeroLevelDimY),
            maxResolution: Math.pow(2, zoomify.numberOfTiers - 1),
            numZoomLevels: zoomify.numberOfTiers,
            units: 'pixels'
        };

        window.openLayersMap = new OpenLayers.Map("map", options);

        openLayersMap.addLayer(zoomify);
        openLayersMap.setBaseLayer(zoomify);
        openLayersMap.addControl(new OpenLayers.Control.LayerSwitcher());
        openLayersMap.addControl(new OpenLayers.Control.OverviewMap({
            minRatio: 0,
            maxRatio: openLayersMap.maxResolution,
            mapOptions: options
        }));
        openLayersMap.zoomToMaxExtent();
        document.getElementById("control").style.visibility = "visible";
        document.getElementById("macro").innerHTML = 'Macro image:<br/><img '
                + 'style="margin:5px 0 0;border:2px solid blue" src="'
                + 'http://localhost:' + port + '/pp-read-special-image?pyramidId=' + pyramidId
                + '&specialImageName=WHOLE_SLIDE&width=200"/>';
    }

    // The function getMyTmsUrl allows to get more control over the syntax of requests to the server.
    // Usually you don't need to use it.
    function getMyTmsUrl(bounds) {
        var res = this.map.getResolution();
        var x = Math.round((bounds.left - this.tileOrigin.lon) / (res * this.tileSize.w));
        var y = Math.round((this.tileOrigin.lat - bounds.top) / (res * this.tileSize.h));
        var z = this.map.getZoom();

        return urlStart + "tms/" + currentPyramidId + "/" + z + "/" + x + "/" + y + ".jpg";
    }

    // The function changePyramid just calls requestPyramid, but also it hides the control and information
    // for the period of initializing new pyramid.
    function changePyramid(newPyramidId, newPort) {
        document.getElementById("control").style.visibility = "hidden";
        window.openLayersMap = null;
        document.getElementById("map").innerHTML = "";
        document.getElementById("information").innerHTML = "Changing pyramid to " + newPyramidId + "...";
        showCurrentZoom();
        setTimeout("requestPyramid('" + newPyramidId + "', " + newPort + ")", 100);
        // setTimeout is necessary to allow browser to really visually hide "control" element
    }

    // The function changeObjective is called by buttons in the div id="control"
    function changeObjective(newObjective) {
        if (window.openLayersMap == null) {
            // openLayersMap is not ready yet
            return;
        }
        var objective = zeroLevelObjective;
        var level = window.openLayersMap.getNumZoomLevels() - 1;
        while (objective > newObjective && level > 0) {
            objective /= 2;
            level--;
        }
        window.openLayersMap.zoomTo(level);
    }

    // The function showCurrentZoom() is called every 1 sec and shows some information about current zoom, etc.
    function showCurrentZoom() {
        if (window.openLayersMap != null) {
            document.getElementById("currentZoom").innerHTML =
                    "Level " + (window.openLayersMap.getZoom() + 1)
                    + " / " + window.openLayersMap.getNumZoomLevels()
                    + ", resolution " + window.openLayersMap.getResolution()
//                    + ", zoom " + window.openLayersMap.getZoomForResolution(window.openLayersMap.getResolution())
        } else {
            document.getElementById("currentZoom").innerHTML = "";
        }
    }
    setInterval(showCurrentZoom, 1000);

</script>


<!-- The following code is for developing and testing goals only -->
<hr style="margin-top:100px">
<div style="font-size:smaller;color:gray">All the following parts are for developnent and debugging needs only
    and should not be included to end-user version

    <script>
        //    document.writeln("<plaintext>");
        //    document.writeln(urlStart);

        //    var args = 'currentPyramidId=' + currentPyramidId + encodeURI('&compression=5&fromX=0&fromY=0&toX=1000&toY=1000');
        //    document.writeln('<br/><img src="' + urlStart + 'read-rectangle?' + args + '"><br/>');

        window.readRectangleHTML = "<br/>Random rectangles:<br/>";
        var compression = 8; // for example
        var tileDimX = 128 * compression;
        var tileDimY = 128 * compression;
        var sizeX = 1024 * compression;
        var sizeY = 512 * compression;
        for (var y = 0; y < sizeY; y += tileDimX) {
            readRectangleHTML += "Line y=" + y + "<br/>";
            for (var x = 0; x < sizeX; x += tileDimX) {
                args = 'pyramidId=' + currentPyramidId
                        + encodeURI('&compression=' + compression
                                + '&fromX=' + x
                                + '&fromY=' + y
                                + '&toX=' + (x + tileDimX)
                                + '&toY=' + (y + tileDimY));
                readRectangleHTML += '<img border="1" src="' + urlStart + 'read-rectangle?' + args + '">&nbsp;';
            }
            readRectangleHTML += "<br/>";
        }

        window.tmsHTML = "<br/>TMS:<br/>";
        var tmsXCount = 5;
        var tmsYCount = 5;
        var tmsZ = 3;
        for (var y = 0; y < tmsYCount; y++) {
            tmsHTML += "Line y=" + y + "<br/>";
            for (var x = 0; x < tmsXCount; x++) {
                args = currentPyramidId + "/" + tmsZ + "/" + x + "/" + y;
                tmsHTML += '<img border="1" src="' + urlStart + 'tms/' + args + '">&nbsp;';
            }
            tmsHTML += "<br/>";
        }
    </script>
    <div id="readRectangleTest" style="margin:20px">
        <button onclick="document.getElementById('readRectangleTest').innerHTML = readRectangleHTML">
            <small>Show test with random access to rectangles</small>
        </button>
    </div>
    <div id="tmsTest" style="margin:20px">
        <button onclick="document.getElementById('tmsTest').innerHTML = tmsHTML">
            <small>Show test with access to rectangles via TMS protocol</small>
        </button>
    </div>
</div>

</body>
</html>